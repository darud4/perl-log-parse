# Тестовое задание, автор - Павел Безруков

## Используемый стек
Тестирование проводилось на UBUNTU 22, Postgres и Apache. Возможно, данная реализация не будет работать на Mysql, если DBI в нем при привязке переменных использует не плейсхолдеры вида :p1, а что-нибудь вроде ?

## Разбор текстового файла и загрузка его в базу данных

### Общая информация
Файл parse.pl. Используется модуль DBI. Реквизиты доступа к базе данных расположены в файле db.conf, который должен располагаться в той же папке, что файл parse.pl. Пример файла:
```
database=dbname
username=dbuser
password=dbpassword
```

### Использование
Запуск - perl parse.pl <Имя файла лога>. Если имя файла лога опущено, используется имя из переменной
$DEFAULT_LOG_FILE, определенной в файле parse.pl.

Остальные параметры (указываются в теле файла parse.pl):
* WRITE_NO_ID_MESSAGES_TO_LOG - Если не 0, то сообщения с флагом <=, у которых не найдена подстрока id=...., пишутся в таблицу log. В этом случае сумма записей в двух таблицах будет равна количеству строк в файле, и каждая запись из файла попадет в одну из таблиц.  Если 0, то такие сообщения не пишутся никуда (в таблицу MESSAGE они не попадают,  так как поле id в ней обязательное, а у них его нет, а в таблицу LOG не попадают,  так как по условию записи с флагом "<=" в нее попадать не должны)
* PURGE_BEFORE_INSERT - Если не 0, то очищает таблицы log и messages перед началом работы, удобно при отладке.

## Поиск по базе данных

### Общая информация

Файл show-logs.pl, используются модули CGI и DBI. Реквизиты доступа в базу данных размещены прямо в теле файла, хотя в продакшне было бы логичнее поместить их в отдельных файл конфигурации и вынести в папку, недоступную для пользователей веб-сервера. Кроме того, в этой реализации скрипт возвращает готовую разметку HTML, в продакшне я бы возвращал JSON, который обрабатывал бы фронтенд. В данной реализации не используется CSS, так как Perl им заниматься, как мне кажется, и не должен, это работа фронтенда.
### Использование
* поместить в папку веб-сервера cgi-bin
* в браузере обратиться по адресу <aдрес сервера>/cgi-bin/show-logs.pl

При вводе в поле запроса адреса электронной почты происходит поиск по таблице log. Таблица message не используется, так как по условию требуется найти адрес получателя, а в таблице message хранятся входящие сообщения, и адреса получателя там нет, только адрес отправителя. Можно было бы реализовать поиск по нему тоже, но структура таблицы в описании не предусматривает отдельного поля для адреса, а без него поиск будет происходить очень неэффективно.
Можно добавить в таблицу message поле address по аналогии с таблицей log, проиндексировать его, тогда возможно организовать поиск по адресам отправителя.

Используемые параметры (указываются в теле файла show-logs.pl):
* $ROWS_LIMIT - лимит записей в результатах запроса, при достижении которого произойдет усечение списка результатов.
* $ROWS_LIMIT_MESSAGE - сообщение, которое будет выдано при достижении лимита записей
* $NO_RESULTS_MESSAGE - сообщение, которое выдается, если по запросу ничего не найдено.
* $BAD_EMAIL_MESSAGE - сообщение, которое выдается, если в поле ввода введен не email

